import os
import re
import glob
import shutil
import numpy as np
from rdkit import Chem
from rdkit.Chem import Descriptors
from mol_inventory import * 
import pandas as pd

# ========== 基础数据 ==========
SMILES_DICT = all_name_mapped_smiles

element_to_mass = {
    'H': 1.008, 'C': 12.011, 'N': 14.007, 'O': 15.999, 'F': 18.998,
    'P': 30.974, 'S': 32.06, 'CL': 35.45, 'BR': 79.904, 'I': 126.90,
    'B': 10.81, 'SI': 28.085,
    'LI': 6.94, 'NA': 22.990, 'K': 39.098, 'MG': 24.305, 'CA': 40.078, 'AL': 26.982,
}

five_mapped_smiles = {
    'HFE': '[F:1][C:2]([F:3])([F:4])[C:5]([H:6])([H:7])[O:8][C:9]([F:10])([F:11])[C:12]([F:13])([F:14])[F:15]',
    'TTE': '[F:1][C:2]([F:3])([F:4])[C:5]([H:6])([F:7])[O:8][C:9]([H:10])([H:11])[C:12]([F:13])([F:14])[C:15]([F:16])([F:17])[F:18]',
    'EMS': '[C:1]([H:2])([H:3])([H:4])[C:5]([H:6])([H:7])[S:8](=[O:9])(=[O:10])[C:11]([H:12])([H:13])([H:14])',
    'EPE': '[C:1]([H:2])([H:3])([H:4])[C:5]([H:6])([H:7])[C:8]([H:9])([H:10])[O:11][C:12]([H:13])([H:14])[C:15]([H:16])([H:17])([H:18])',
    'DME': '[C:1]([O:2][C:3]([C:4]([O:5][C:6]([H:14])([H:15])[H:16])([H:12])[H:13])([H:10])[H:11])([H:7])([H:8])[H:9]',
    'PO7': '[C:1]([O:2][C:3]([C:4]([O:5][C:6]([C:7]([O:8][C:9]([C:10]([O:11][C:12]([C:13]([O:14][C:15]([C:16]([O:17][C:18]([C:19]([O:20][C:21]([C:22]([O:23][C:24]([H:56])([H:57])[H:58])([H:54])[H:55])([H:52])[H:53])([H:50])[H:51])([H:48])[H:49])([H:46])[H:47])([H:44])[H:45])([H:42])[H:43])([H:40])[H:41])([H:38])[H:39])([H:36])[H:37])([H:34])[H:35])([H:32])[H:33])([H:30])[H:31])([H:28])[H:29])([H:25])([H:26])[H:27]',
    'FMPS': '[C:1]([C:2]([C:3]([S:4](=[O:5])(=[O:6])[C:7]([F:8])([F:9])[F:10])([H:16])[H:17])([H:14])[H:15])([H:11])([H:12])[H:13]',
    'FMES': '[C:1]([C:2]([S:3](=[O:4])(=[O:5])[C:6]([F:7])([F:8])[F:9])([H:13])[H:14])([H:10])([H:11])[H:12]',
    'EMS':'[C:1]([C:2]([S:3]([C:4]([H:12])([H:13])[H:14])(=[O:5])=[O:6])([H:10])[H:11])([H:7])([H:8])[H:9]',
    'MIS':'[C:1]([C:2]([C:3]([H:12])([H:13])[H:14])([S:4]([C:5]([H:15])([H:16])[H:17])(=[O:6])=[O:7])[H:11])([H:8])([H:9])[H:10]',
    'FMIS':'[C:1]([C:2]([C:3]([H:15])([H:16])[H:17])([S:4](=[O:5])(=[O:6])[C:7]([F:8])([F:9])[F:10])[H:14])([H:11])([H:12])[H:13]',
    'FPMS':'[C:1]([S:2](=[O:3])(=[O:4])[C:5]([C:6]([C:7]([F:8])([F:9])[F:10])([H:16])[H:17])([H:14])[H:15])([H:11])([H:12])[H:13]',
    'PTHF':'[C:1]([O:2][C:3]([C:4]([C:5]([C:6]([O:7][C:8]([C:9]([C:10]([C:11]([O:12][C:13]([C:14]([C:15]([C:16]([O:17][C:18]([C:19]([C:20]([C:21]([O:22][C:23]([C:24]([C:25]([C:26]([O:27][C:28]([C:29]([C:30]([C:31]([O:32][C:33]([C:34]([C:35]([C:36]([O:37][C:38]([C:39]([C:40]([C:41]([O:42][C:43]([C:44]([C:45]([C:46]([O:47][C:48]([C:49]([C:50]([C:51]([O:52][C:53]([C:54]([C:55]([C:56]([O:57][C:58]([C:59]([C:60]([C:61]([O:62][C:63]([C:64]([C:65]([C:66]([O:67][C:68]([C:69]([C:70]([C:71]([O:72][C:73]([C:74]([C:75]([C:76]([O:77][C:78]([C:79]([C:80]([C:81]([O:82][C:83]([C:84]([C:85]([C:86]([O:87][C:88]([C:89]([C:90]([C:91]([O:92][C:93]([C:94]([C:95]([C:96]([O:97][C:98]([C:99]([C:100]([C:101]([O:102][C:103]([C:104]([C:105]([C:106]([O:107][C:108]([C:109]([C:110]([C:111]([O:112][C:113]([C:114]([C:115]([C:116]([O:117][C:118]([C:119]([C:120]([C:121]([O:122][C:123]([C:124]([C:125]([C:126]([O:127][C:128]([C:129]([C:130]([C:131]([O:132][C:133]([C:134]([C:135]([C:136]([O:137][C:138]([C:139]([C:140]([C:141]([O:142][C:143]([C:144]([C:145]([C:146]([O:147][C:148]([C:149]([C:150]([C:151]([O:152][C:153]([C:154]([C:155]([C:156]([O:157][C:158]([C:159]([C:160]([C:161]([O:162][C:163]([C:164]([C:165]([C:166]([O:167][C:168]([C:169]([C:170]([C:171]([O:172][C:173]([H:449])([H:450])[H:451])([H:447])[H:448])([H:445])[H:446])([H:443])[H:444])([H:441])[H:442])([H:439])[H:440])([H:437])[H:438])([H:435])[H:436])([H:433])[H:434])([H:431])[H:432])([H:429])[H:430])([H:427])[H:428])([H:425])[H:426])([H:423])[H:424])([H:421])[H:422])([H:419])[H:420])([H:417])[H:418])([H:415])[H:416])([H:413])[H:414])([H:411])[H:412])([H:409])[H:410])([H:407])[H:408])([H:405])[H:406])([H:403])[H:404])([H:401])[H:402])([H:399])[H:400])([H:397])[H:398])([H:395])[H:396])([H:393])[H:394])([H:391])[H:392])([H:389])[H:390])([H:387])[H:388])([H:385])[H:386])([H:383])[H:384])([H:381])[H:382])([H:379])[H:380])([H:377])[H:378])([H:375])[H:376])([H:373])[H:374])([H:371])[H:372])([H:369])[H:370])([H:367])[H:368])([H:365])[H:366])([H:363])[H:364])([H:361])[H:362])([H:359])[H:360])([H:357])[H:358])([H:355])[H:356])([H:353])[H:354])([H:351])[H:352])([H:349])[H:350])([H:347])[H:348])([H:345])[H:346])([H:343])[H:344])([H:341])[H:342])([H:339])[H:340])([H:337])[H:338])([H:335])[H:336])([H:333])[H:334])([H:331])[H:332])([H:329])[H:330])([H:327])[H:328])([H:325])[H:326])([H:323])[H:324])([H:321])[H:322])([H:319])[H:320])([H:317])[H:318])([H:315])[H:316])([H:313])[H:314])([H:311])[H:312])([H:309])[H:310])([H:307])[H:308])([H:305])[H:306])([H:303])[H:304])([H:301])[H:302])([H:299])[H:300])([H:297])[H:298])([H:295])[H:296])([H:293])[H:294])([H:291])[H:292])([H:289])[H:290])([H:287])[H:288])([H:285])[H:286])([H:283])[H:284])([H:281])[H:282])([H:279])[H:280])([H:277])[H:278])([H:275])[H:276])([H:273])[H:274])([H:271])[H:272])([H:269])[H:270])([H:267])[H:268])([H:265])[H:266])([H:263])[H:264])([H:261])[H:262])([H:259])[H:260])([H:257])[H:258])([H:255])[H:256])([H:253])[H:254])([H:251])[H:252])([H:249])[H:250])([H:247])[H:248])([H:245])[H:246])([H:243])[H:244])([H:241])[H:242])([H:239])[H:240])([H:237])[H:238])([H:235])[H:236])([H:233])[H:234])([H:231])[H:232])([H:229])[H:230])([H:227])[H:228])([H:225])[H:226])([H:223])[H:224])([H:221])[H:222])([H:219])[H:220])([H:217])[H:218])([H:215])[H:216])([H:213])[H:214])([H:211])[H:212])([H:209])[H:210])([H:207])[H:208])([H:205])[H:206])([H:203])[H:204])([H:201])[H:202])([H:199])[H:200])([H:197])[H:198])([H:195])[H:196])([H:193])[H:194])([H:191])[H:192])([H:189])[H:190])([H:187])[H:188])([H:185])[H:186])([H:183])[H:184])([H:181])[H:182])([H:179])[H:180])([H:177])[H:178])([H:174])([H:175])[H:176]',
    'PEO':'[C:1]([O:2][C:3]([C:4]([O:5][C:6]([C:7]([O:8][C:9]([C:10]([O:11][C:12]([C:13]([O:14][C:15]([C:16]([O:17][C:18]([C:19]([O:20][C:21]([C:22]([O:23][C:24]([C:25]([O:26][C:27]([C:28]([O:29][C:30]([C:31]([O:32][C:33]([C:34]([O:35][C:36]([C:37]([O:38][C:39]([C:40]([O:41][C:42]([C:43]([O:44][C:45]([C:46]([O:47][C:48]([C:49]([O:50][C:51]([C:52]([O:53][C:54]([C:55]([O:56][C:57]([C:58]([O:59][C:60]([C:61]([O:62][C:63]([C:64]([O:65][C:66]([C:67]([O:68][C:69]([C:70]([O:71][C:72]([C:73]([O:74][C:75]([C:76]([O:77][C:78]([C:79]([O:80][C:81]([C:82]([O:83][C:84]([C:85]([O:86][C:87]([C:88]([O:89][C:90]([C:91]([O:92][C:93]([C:94]([O:95][C:96]([C:97]([O:98][C:99]([C:100]([O:101][C:102]([C:103]([O:104][C:105]([C:106]([O:107][C:108]([C:109]([O:110][C:111]([C:112]([O:113][C:114]([C:115]([O:116][C:117]([C:118]([O:119][C:120]([C:121]([O:122][C:123]([C:124]([O:125][C:126]([C:127]([O:128][C:129]([C:130]([O:131][C:132]([C:133]([O:134][C:135]([C:136]([O:137][C:138]([C:139]([O:140][C:141]([C:142]([O:143][C:144]([C:145]([O:146][C:147]([C:148]([O:149][C:150]([C:151]([O:152][C:153]([C:154]([O:155][C:156]([C:157]([O:158][C:159]([C:160]([O:161][C:162]([C:163]([O:164][C:165]([H:385])([H:386])[H:387])([H:383])[H:384])([H:381])[H:382])([H:379])[H:380])([H:377])[H:378])([H:375])[H:376])([H:373])[H:374])([H:371])[H:372])([H:369])[H:370])([H:367])[H:368])([H:365])[H:366])([H:363])[H:364])([H:361])[H:362])([H:359])[H:360])([H:357])[H:358])([H:355])[H:356])([H:353])[H:354])([H:351])[H:352])([H:349])[H:350])([H:347])[H:348])([H:345])[H:346])([H:343])[H:344])([H:341])[H:342])([H:339])[H:340])([H:337])[H:338])([H:335])[H:336])([H:333])[H:334])([H:331])[H:332])([H:329])[H:330])([H:327])[H:328])([H:325])[H:326])([H:323])[H:324])([H:321])[H:322])([H:319])[H:320])([H:317])[H:318])([H:315])[H:316])([H:313])[H:314])([H:311])[H:312])([H:309])[H:310])([H:307])[H:308])([H:305])[H:306])([H:303])[H:304])([H:301])[H:302])([H:299])[H:300])([H:297])[H:298])([H:295])[H:296])([H:293])[H:294])([H:291])[H:292])([H:289])[H:290])([H:287])[H:288])([H:285])[H:286])([H:283])[H:284])([H:281])[H:282])([H:279])[H:280])([H:277])[H:278])([H:275])[H:276])([H:273])[H:274])([H:271])[H:272])([H:269])[H:270])([H:267])[H:268])([H:265])[H:266])([H:263])[H:264])([H:261])[H:262])([H:259])[H:260])([H:257])[H:258])([H:255])[H:256])([H:253])[H:254])([H:251])[H:252])([H:249])[H:250])([H:247])[H:248])([H:245])[H:246])([H:243])[H:244])([H:241])[H:242])([H:239])[H:240])([H:237])[H:238])([H:235])[H:236])([H:233])[H:234])([H:231])[H:232])([H:229])[H:230])([H:227])[H:228])([H:225])[H:226])([H:223])[H:224])([H:221])[H:222])([H:219])[H:220])([H:217])[H:218])([H:215])[H:216])([H:213])[H:214])([H:211])[H:212])([H:209])[H:210])([H:207])[H:208])([H:205])[H:206])([H:203])[H:204])([H:201])[H:202])([H:199])[H:200])([H:197])[H:198])([H:195])[H:196])([H:193])[H:194])([H:191])[H:192])([H:189])[H:190])([H:187])[H:188])([H:185])[H:186])([H:183])[H:184])([H:181])[H:182])([H:179])[H:180])([H:177])[H:178])([H:175])[H:176])([H:173])[H:174])([H:171])[H:172])([H:169])[H:170])([H:166])([H:167])[H:168]',
    'PDOL':'[C:1]([O:2][C:3]([C:4]([O:5][C:6]([O:7][C:8]([C:9]([O:10][C:11]([O:12][C:13]([C:14]([O:15][C:16]([O:17][C:18]([C:19]([O:20][C:21]([O:22][C:23]([C:24]([O:25][C:26]([O:27][C:28]([C:29]([O:30][C:31]([O:32][C:33]([C:34]([O:35][C:36]([O:37][C:38]([C:39]([O:40][C:41]([O:42][C:43]([C:44]([O:45][C:46]([O:47][C:48]([C:49]([O:50][C:51]([O:52][C:53]([C:54]([O:55][C:56]([O:57][C:58]([C:59]([O:60][C:61]([O:62][C:63]([C:64]([O:65][C:66]([O:67][C:68]([C:69]([O:70][C:71]([O:72][C:73]([C:74]([O:75][C:76]([O:77][C:78]([C:79]([O:80][C:81]([O:82][C:83]([C:84]([O:85][C:86]([O:87][C:88]([C:89]([O:90][C:91]([O:92][C:93]([C:94]([O:95][C:96]([O:97][C:98]([C:99]([O:100][C:101]([O:102][C:103]([C:104]([O:105][C:106]([O:107][C:108]([C:109]([O:110][C:111]([O:112][C:113]([C:114]([O:115][C:116]([O:117][C:118]([C:119]([O:120][C:121]([O:122][C:123]([C:124]([O:125][C:126]([O:127][C:128]([C:129]([O:130][C:131]([O:132][C:133]([C:134]([O:135][C:136]([O:137][C:138]([C:139]([O:140][C:141]([O:142][C:143]([C:144]([O:145][C:146]([O:147][C:148]([C:149]([O:150][C:151]([O:152][C:153]([C:154]([O:155][C:156]([O:157][C:158]([C:159]([O:160][C:161]([O:162][C:163]([C:164]([O:165][C:166]([O:167][C:168]([C:169]([O:170][C:171]([O:172][C:173]([H:381])([H:382])[H:383])([H:379])[H:380])([H:377])[H:378])([H:375])[H:376])([H:373])[H:374])([H:371])[H:372])([H:369])[H:370])([H:367])[H:368])([H:365])[H:366])([H:363])[H:364])([H:361])[H:362])([H:359])[H:360])([H:357])[H:358])([H:355])[H:356])([H:353])[H:354])([H:351])[H:352])([H:349])[H:350])([H:347])[H:348])([H:345])[H:346])([H:343])[H:344])([H:341])[H:342])([H:339])[H:340])([H:337])[H:338])([H:335])[H:336])([H:333])[H:334])([H:331])[H:332])([H:329])[H:330])([H:327])[H:328])([H:325])[H:326])([H:323])[H:324])([H:321])[H:322])([H:319])[H:320])([H:317])[H:318])([H:315])[H:316])([H:313])[H:314])([H:311])[H:312])([H:309])[H:310])([H:307])[H:308])([H:305])[H:306])([H:303])[H:304])([H:301])[H:302])([H:299])[H:300])([H:297])[H:298])([H:295])[H:296])([H:293])[H:294])([H:291])[H:292])([H:289])[H:290])([H:287])[H:288])([H:285])[H:286])([H:283])[H:284])([H:281])[H:282])([H:279])[H:280])([H:277])[H:278])([H:275])[H:276])([H:273])[H:274])([H:271])[H:272])([H:269])[H:270])([H:267])[H:268])([H:265])[H:266])([H:263])[H:264])([H:261])[H:262])([H:259])[H:260])([H:257])[H:258])([H:255])[H:256])([H:253])[H:254])([H:251])[H:252])([H:249])[H:250])([H:247])[H:248])([H:245])[H:246])([H:243])[H:244])([H:241])[H:242])([H:239])[H:240])([H:237])[H:238])([H:235])[H:236])([H:233])[H:234])([H:231])[H:232])([H:229])[H:230])([H:227])[H:228])([H:225])[H:226])([H:223])[H:224])([H:221])[H:222])([H:219])[H:220])([H:217])[H:218])([H:215])[H:216])([H:213])[H:214])([H:211])[H:212])([H:209])[H:210])([H:207])[H:208])([H:205])[H:206])([H:203])[H:204])([H:201])[H:202])([H:199])[H:200])([H:197])[H:198])([H:195])[H:196])([H:193])[H:194])([H:191])[H:192])([H:189])[H:190])([H:187])[H:188])([H:185])[H:186])([H:183])[H:184])([H:181])[H:182])([H:179])[H:180])([H:177])[H:178])([H:174])([H:175])[H:176]',
    'PTOM':'[C:1]([C:2]([O:3][C:4]([O:5][C:6]([O:7][C:8]([O:9][C:10]([O:11][C:12]([O:13][C:14]([O:15][C:16]([O:17][C:18]([O:19][C:20]([O:21][C:22]([O:23][C:24]([O:25][C:26]([O:27][C:28]([O:29][C:30]([O:31][C:32]([O:33][C:34]([O:35][C:36]([O:37][C:38]([O:39][C:40]([O:41][C:42]([O:43][C:44]([O:45][C:46]([O:47][C:48]([O:49][C:50]([O:51][C:52]([O:53][C:54]([O:55][C:56]([O:57][C:58]([O:59][C:60]([O:61][C:62]([O:63][C:64]([O:65][C:66]([O:67][C:68]([O:69][C:70]([O:71][C:72]([O:73][C:74]([O:75][C:76]([O:77][C:78]([O:79][C:80]([O:81][C:82]([O:83][C:84]([O:85][C:86]([O:87][C:88]([O:89][C:90]([O:91][C:92]([O:93][C:94]([O:95][C:96]([O:97][C:98]([O:99][C:100]([O:101][C:102]([O:103][C:104]([O:105][C:106]([O:107][C:108]([O:109][C:110]([O:111][C:112]([O:113][C:114]([O:115][C:116]([O:117][C:118]([O:119][C:120]([O:121][C:122]([O:123][C:124]([O:125][C:126]([O:127][C:128]([O:129][C:130]([O:131][C:132]([O:133][C:134]([O:135][C:136]([O:137][C:138]([O:139][C:140]([O:141][C:142]([O:143][C:144]([O:145][C:146]([O:147][C:148]([O:149][C:150]([O:151][C:152]([O:153][C:154]([O:155][C:156]([O:157][C:158]([O:159][C:160]([O:161][C:162]([O:163][C:164]([H:330])([H:331])[H:332])([H:328])[H:329])([H:326])[H:327])([H:324])[H:325])([H:322])[H:323])([H:320])[H:321])([H:318])[H:319])([H:316])[H:317])([H:314])[H:315])([H:312])[H:313])([H:310])[H:311])([H:308])[H:309])([H:306])[H:307])([H:304])[H:305])([H:302])[H:303])([H:300])[H:301])([H:298])[H:299])([H:296])[H:297])([H:294])[H:295])([H:292])[H:293])([H:290])[H:291])([H:288])[H:289])([H:286])[H:287])([H:284])[H:285])([H:282])[H:283])([H:280])[H:281])([H:278])[H:279])([H:276])[H:277])([H:274])[H:275])([H:272])[H:273])([H:270])[H:271])([H:268])[H:269])([H:266])[H:267])([H:264])[H:265])([H:262])[H:263])([H:260])[H:261])([H:258])[H:259])([H:256])[H:257])([H:254])[H:255])([H:252])[H:253])([H:250])[H:251])([H:248])[H:249])([H:246])[H:247])([H:244])[H:245])([H:242])[H:243])([H:240])[H:241])([H:238])[H:239])([H:236])[H:237])([H:234])[H:235])([H:232])[H:233])([H:230])[H:231])([H:228])[H:229])([H:226])[H:227])([H:224])[H:225])([H:222])[H:223])([H:220])[H:221])([H:218])[H:219])([H:216])[H:217])([H:214])[H:215])([H:212])[H:213])([H:210])[H:211])([H:208])[H:209])([H:206])[H:207])([H:204])[H:205])([H:202])[H:203])([H:200])[H:201])([H:198])[H:199])([H:196])[H:197])([H:194])[H:195])([H:192])[H:193])([H:190])[H:191])([H:188])[H:189])([H:186])[H:187])([H:184])[H:185])([H:182])[H:183])([H:180])[H:181])([H:178])[H:179])([H:176])[H:177])([H:174])[H:175])([H:172])[H:173])([H:170])[H:171])([H:168])[H:169])([H:165])([H:166])[H:167]',
}

SMILES_DICT.update(five_mapped_smiles)
tenary_mapped_smiles = {
 'T1': '[C:1]1([H:22])([H:23])[C:2]([C:8]2([H:25])[C:9]([C:15]3([H:27])[C:16]([H:28])([H:29])[O:17][S:18](=[O:19])(=[O:20])[O:21]3)([H:26])[O:10][S:11](=[O:12])(=[O:13])[O:14]2)([H:24])[O:3][S:4](=[O:5])(=[O:6])[O:7]1',
 'T2': '[c:1]1([H:31])[c:2]([H:32])[c:3]([H:33])[c:4]([C:7](=[O:8])[O:9][C:10]([C:11]([C:12]([O:13][C:14](=[O:15])[c:16]2[c:17]([H:41])[c:18]([H:42])[c:19]([H:43])[c:20]([H:44])[c:21]2[H:45])([H:39])[H:40])([O:22][C:23](=[O:24])[c:25]2[c:26]([H:46])[c:27]([H:47])[c:28]([H:48])[c:29]([H:49])[c:30]2[H:50])[H:38])([H:36])[H:37])[c:5]([H:34])[c:6]1[H:35]',
 'T3': '[C:1]([O:2][Si:3]([C:4]([C:5]([C:6]([n:7]1[c:8](=[O:9])[n:10]([C:26]([C:27]([C:28]([Si:29]([O:30][C:31]([H:70])([H:71])[H:72])([O:32][C:33]([H:73])([H:74])[H:75])[O:34][C:35]([H:76])([H:77])[H:78])([H:68])[H:69])([H:66])[H:67])([H:64])[H:65])[c:11](=[O:12])[n:13]([C:16]([C:17]([C:18]([Si:19]([O:20][C:21]([H:55])([H:56])[H:57])([O:22][C:23]([H:58])([H:59])[H:60])[O:24][C:25]([H:61])([H:62])[H:63])([H:53])[H:54])([H:51])[H:52])([H:49])[H:50])[c:14]1=[O:15])([H:47])[H:48])([H:45])[H:46])([H:43])[H:44])([O:36][C:37]([H:79])([H:80])[H:81])[O:38][C:39]([H:82])([H:83])[H:84])([H:40])([H:41])[H:42]',
 'T4': '[c:1]1([H:14])[c:2]([H:15])[c:3]([H:16])[c:4]([H:17])[c:5]([H:18])[n+:6]1[C:7]([N-:8][S:9](=[O:10])(=[O:11])[F:12])=[O:13]',
 'T5': '[C:1]([C:2]([C:3]([N:4]([C:5](=[S:6])[N:7]([H:16])[H:17])[H:15])([H:13])[H:14])([H:11])[H:12])([H:8])([H:9])[H:10]',
 'T6': '[C:1]1([H:8])([H:9])[C:2]([H:10])([H:11])[C:3]([H:12])([H:13])[S:4](=[O:5])(=[O:6])[O:7]1',
 'T7': '[C:1]([C:2]([C:3]([C:4]([C:5]([C:6]([C:7]1([H:26])[C:8]([H:27])([H:28])[O:9][C:10](=[O:11])[O:12]1)([H:24])[H:25])([H:22])[H:23])([H:20])[H:21])([H:18])[H:19])([H:16])[H:17])([H:13])([H:14])[H:15]',
 'T8': '[S:1]([C:2]([C:3]([C:4]([C:5]([C:6]([C:7]([H:24])([H:25])[H:26])([H:22])[H:23])([H:20])[H:21])([H:18])[H:19])([H:16])[H:17])([H:14])[H:15])[C:8]([C:9]([C:10]([C:11]([C:12]([C:13]([H:37])([H:38])[H:39])([H:35])[H:36])([H:33])[H:34])([H:31])[H:32])([H:29])[H:30])([H:27])[H:28]',
 'T9': '[C:1]([C:2]([C:3]([C:4]([C:5]([C:6]([C:7]([H:41])([H:42])[H:43])([H:39])[H:40])([C:8]([O:9][C:10](=[O:11])[c:12]1[c:13]([H:46])[c:14]([H:47])[c:15]([H:48])[c:16]([H:49])[c:17]1[C:18](=[O:19])[O:20][C:21]([C:22]([C:23]([C:24]([H:55])([H:56])[H:57])([H:53])[H:54])([C:25]([C:26]([C:27]([C:28]([H:64])([H:65])[H:66])([H:62])[H:63])([H:60])[H:61])([H:58])[H:59])[H:52])([H:50])[H:51])([H:44])[H:45])[H:38])([H:36])[H:37])([H:34])[H:35])([H:32])[H:33])([H:29])([H:30])[H:31]',
 'T10': '[C:1]1([H:8])([H:9])[C:2]([H:10])([H:11])[O:3][S:4](=[O:5])(=[O:6])[O:7]1',
 'T11': '[C:1]1([H:8])([H:9])[C:2]([F:7])([H:10])[O:3][C:4](=[O:5])[O:6]1',
 'T12': '[C:1]1([H:10])([H:11])[C:2]([H:12])([H:13])[C:3]([H:14])([H:15])[C:4]([N:7]=[C:8]=[S:9])([H:16])[C:5]([H:17])([H:18])[C:6]1([H:19])[H:20]',
 'T13': '[C:1]1([H:6])([H:7])[C:2]([H:8])([H:9])[C:3]1([C:4]#[N:5])[H:10]',
 'AA0': '[N:1]#[C:2][C:3]([C:4]([N:5]([C:6]([C:7]([C:8]#[N:9])([H:20])[H:21])([H:18])[H:19])[C:10]([C:11]([C:12]#[N:13])([H:24])[H:25])([H:22])[H:23])([H:16])[H:17])([H:14])[H:15]',
 'AA1': '[C:1]([C:2]([C:3]([C:4]([N:5]([C:6]([C:7]([C:8]([C:9]([H:40])([H:41])[H:42])([H:38])[H:39])([H:36])[H:37])([H:34])[H:35])[C:10](=[S:11])[S:12][S:13][C:14](=[S:15])[N:16]([C:17]([C:18]([C:19]([C:20]([H:49])([H:50])[H:51])([H:47])[H:48])([H:45])[H:46])([H:43])[H:44])[C:21]([C:22]([C:23]([C:24]([H:58])([H:59])[H:60])([H:56])[H:57])([H:54])[H:55])([H:52])[H:53])([H:32])[H:33])([H:30])[H:31])([H:28])[H:29])([H:25])([H:26])[H:27]',
 'AA2': '[C:1]([C:2]([C:3]([C:4]([N:5]([C:6]([C:7]([C:8]([C:9]([H:29])([H:30])[H:31])([H:27])[H:28])([H:25])[H:26])([H:23])[H:24])[C:10](=[S:11])[S-:12])([H:21])[H:22])([H:19])[H:20])([H:17])[H:18])([H:14])([H:15])[H:16].[Na+:13]',
 'AA3': '[C:1]([N:2]([C:3]([H:11])([H:12])[H:13])[C:4]([C:5]([C:6]#[N:7])([H:16])[H:17])([H:14])[H:15])([H:8])([H:9])[H:10]',
 'AA4': '[C:1]([C:2]([C:3]([H:22])([H:23])[H:24])([C:4]([H:25])([H:26])[H:27])[O:5][C:6](=[O:7])[N:8]1[C:9]([H:28])([H:29])[C:10]([H:30])([H:31])[C:11]([C:12](=[O:13])[C:14]([C:15]#[N:16])([H:33])[H:34])([H:32])[C:17]([H:35])([H:36])[C:18]1([H:37])[H:38])([H:19])([H:20])[H:21]',
 'AA5': '[C:1](=[C:2]([N:3]1[C:4]([H:14])([H:15])[C:5]([H:16])([H:17])[C:6]([H:18])([H:19])[C:7]([H:20])([H:21])[C:8]([H:22])([H:23])[C:9]1=[O:10])[H:13])([H:11])[H:12]',
 'AA6': '[C:1]([C:2]1([C:3]([H:15])([H:16])[H:17])[C:4]([H:18])([H:19])[C:5]([H:20])([H:21])[C:6]([H:22])([H:23])[C:7]([C:8]([H:24])([H:25])[H:26])([C:9]([H:27])([H:28])[H:29])[N:10]1[O:11])([H:12])([H:13])[H:14]',
 'AA7': '[S:1]=[C:2]([S:3][N:4]1[C:5]([H:16])([H:17])[C:6]([H:18])([H:19])[O:7][C:8]([H:20])([H:21])[C:9]1([H:22])[H:23])[N:10]1[C:11]([H:24])([H:25])[C:12]([H:26])([H:27])[O:13][C:14]([H:28])([H:29])[C:15]1([H:30])[H:31]',
 'AA8': '[C:1]([C:2]1([H:13])[C:3]([H:14])([H:15])[N:4]([C:5]([H:16])([H:17])[H:18])[C:6]([H:19])([H:20])[C:7]([H:21])([H:22])[C:8]1=[O:9])([H:10])([H:11])[H:12]',
 'AA9': '[O:1]=[C:2]1[C:3]([H:11])([H:12])[C:4]([H:13])([H:14])[N:5]([C:6]2([H:15])[C:7]([H:16])([H:17])[C:8]2([H:18])[H:19])[C:9]([H:20])([H:21])[C:10]1([H:22])[H:23]',
 'AB0': '[N:1]#[C:2][C:3]([C:4](=[O:5])[N:6]1[C:7]([H:14])([H:15])[C:8]([H:16])([H:17])[C:9]([H:18])([H:19])[C:10]([H:20])([H:21])[C:11]1([H:22])[H:23])([H:12])[H:13]',
 'AB1': '[C:1]([C:2]([O:3][C:4](=[O:5])[C:6](=[C:7]([C:8]([H:20])([H:21])[H:22])[N:9]1[C:10]([H:23])([H:24])[C:11]([H:25])([H:26])[C:12]([H:27])([H:28])[C:13]1([H:29])[H:30])[H:19])([H:17])[H:18])([H:14])([H:15])[H:16]',
 'AB2': '[C:1]([C:2]([O:3][C:4](=[C:5]([C:6](=[O:7])[O:8][C:9]([C:10]([H:20])([H:21])[H:22])([H:18])[H:19])[H:17])[H:16])([H:14])[H:15])([H:11])([H:12])[H:13]',
 'AB3': '[C:1]([C:2]([C:3]([H:12])([H:13])[H:14])([C:4]([O:5][N:6]=[O:7])([H:15])[H:16])[H:11])([H:8])([H:9])[H:10]',
 'AB4': '[C:1]([N+:2]([C:3]([H:12])([H:13])[H:14])([C:4]([H:15])([H:16])[H:17])[C:5]([C:6](=[O:7])[O-:8])([H:18])[H:19])([H:9])([H:10])[H:11]',
 'AB5': '[C:1]([C:2](=[O:3])[C:4]([C:5]([C:6]([C:7]([H:20])([H:21])[H:22])([C:8]([H:23])([H:24])[H:25])[H:19])([H:17])[H:18])([C:9]([N:10]([C:11]([H:28])([H:29])[H:30])[C:12]([H:31])([H:32])[H:33])([H:26])[H:27])[H:16])([H:13])([H:14])[H:15]',
 'AB6': '[C:1](=[C:2]([C:3]([N:4]1[C:5]([H:15])([H:16])[C:6]([H:17])([H:18])[O:7][C:8]([H:19])([H:20])[C:9]1([H:21])[H:22])([H:13])[H:14])[H:12])([H:10])[H:11]',
 'AB7': '[S:1]=[C:2]([S:3][S:4][S:5][S:6][S:7][S:8][C:9](=[S:10])[N:11]1[C:12]([H:23])([H:24])[C:13]([H:25])([H:26])[C:14]([H:27])([H:28])[C:15]([H:29])([H:30])[C:16]1([H:31])[H:32])[N:17]1[C:18]([H:33])([H:34])[C:19]([H:35])([H:36])[C:20]([H:37])([H:38])[C:21]([H:39])([H:40])[C:22]1([H:41])[H:42]',
 'AB8': '[S:1]=[C:2]([S:3][S:4][S:5][S:6][C:7](=[S:8])[N:9]1[C:10]([H:21])([H:22])[C:11]([H:23])([H:24])[C:12]([H:25])([H:26])[C:13]([H:27])([H:28])[C:14]1([H:29])[H:30])[N:15]1[C:16]([H:31])([H:32])[C:17]([H:33])([H:34])[C:18]([H:35])([H:36])[C:19]([H:37])([H:38])[C:20]1([H:39])[H:40]',
 'AB9': '[O:1]=[N:2][N:3]1[C:4]([H:8])([H:9])[C:5]([H:10])([H:11])[C:6]([H:12])([H:13])[C:7]1([H:14])[H:15]',
 'AC0': '[C:1]([O:2][C:3]([C:4]([C:5]([N:6]1[C:7]([H:22])([H:23])[C:8]([H:24])([H:25])[C:9](=[O:10])[C:11]([H:26])([H:27])[C:12]1([H:28])[H:29])([H:20])[H:21])([H:18])[H:19])([H:16])[H:17])([H:13])([H:14])[H:15]',
 'AC1': '[C:1]([C:2]([C:3]([N:4]1[C:5]([H:18])([H:19])[C:6]([H:20])([H:21])[C:7](=[O:8])[C:9]([H:22])([H:23])[C:10]1([H:24])[H:25])([H:16])[H:17])([H:14])[H:15])([H:11])([H:12])[H:13]',
 'AC2': '[C:1]([C:2]([N:3]1[C:4](=[O:5])[C:6]([H:15])([H:16])[S:7][C:8]1=[S:9])([H:13])[H:14])([H:10])([H:11])[H:12]',
 'AC3': '[C:1]([C:2]([N:3]1[C:4]([H:15])([H:16])[C:5]([H:17])([H:18])[C:6](=[O:7])[C:8]([H:19])([H:20])[C:9]1([H:21])[H:22])([H:13])[H:14])([H:10])([H:11])[H:12]',
 'AC4': '[C:1]([C:2]([C:3]([H:16])([H:17])[H:18])([C:4]([N:5]1[C:6]([H:21])([H:22])[C:7]([H:23])([H:24])[C:8](=[O:9])[C:10]([H:25])([H:26])[C:11]1([H:27])[H:28])([H:19])[H:20])[H:15])([H:12])([H:13])[H:14]',
 'AC5': '[C:1](=[C:2]([Si:3]1([C:4]([H:19])([H:20])[H:21])[O:5][Si:6]([C:7]([H:22])([H:23])[H:24])([C:8](=[C:9]([H:26])[H:27])[H:25])[O:10][Si:11]([C:12]([H:28])([H:29])[H:30])([C:13](=[C:14]([H:32])[H:33])[H:31])[O:15]1)[H:18])([H:16])[H:17]',
 'AC6': '[C:1]([C:2]1([H:21])[C:3]([C:4]#[N:5])([H:22])[C:6](=[O:7])[C:8]([H:23])([H:24])[C:9]([H:25])([H:26])[N:10]1[C:11](=[O:12])[O:13][C:14]([C:15]([H:27])([H:28])[H:29])([C:16]([H:30])([H:31])[H:32])[C:17]([H:33])([H:34])[H:35])([H:18])([H:19])[H:20]',
 'AC7': '[O:1]=[N:2][N:3]1[C:4]([H:9])([H:10])[C:5]([H:11])([H:12])[O:6][C:7]([H:13])([H:14])[C:8]1([H:15])[H:16]',
 'AC8': '[C:1]([N:2]1[C:3]([H:11])([H:12])[C:4]([H:13])([H:14])[C:5]([H:15])([H:16])[C:6]1=[S:7])([H:8])([H:9])[H:10]',
 'AC9': '[C:1]([N:2]1[C:3]([H:12])([H:13])[C:4]([H:14])([H:15])[N:5]([C:6]([H:16])([H:17])[H:18])[C:7]1=[S:8])([H:9])([H:10])[H:11]',
 'AD0': '[C:1]1([H:15])([H:16])[C:2]([H:17])([H:18])[N:3]([S:4][S:5][N:6]2[C:7]([H:19])([H:20])[C:8]([H:21])([H:22])[O:9][C:10]([H:23])([H:24])[C:11]2([H:25])[H:26])[C:12]([H:27])([H:28])[C:13]([H:29])([H:30])[O:14]1',
 'AD1': '[C:1]([C:2]([C:3]([H:29])([H:30])[H:31])([C:4]([N:5]([C:6]([C:7]([C:8]([H:37])([H:38])[H:39])([C:9]([H:40])([H:41])[H:42])[H:36])([H:34])[H:35])[C:10](=[S:11])[S:12][S:13][C:14](=[S:15])[N:16]([C:17]([C:18]([C:19]([H:46])([H:47])[H:48])([C:20]([H:49])([H:50])[H:51])[H:45])([H:43])[H:44])[C:21]([C:22]([C:23]([H:55])([H:56])[H:57])([C:24]([H:58])([H:59])[H:60])[H:54])([H:52])[H:53])([H:32])[H:33])[H:28])([H:25])([H:26])[H:27]',
 'AD2': '[C:1]([C:2]([C:3](=[O:4])[C:5]([C:6]([H:17])([H:18])[H:19])([C:7]([N:8]([C:9]([H:22])([H:23])[H:24])[C:10]([H:25])([H:26])[H:27])([H:20])[H:21])[H:16])([H:14])[H:15])([H:11])([H:12])[H:13]',
 'AD3': '[C:1]([O:2][C:3](=[O:4])[c:5]1[c:6]([H:19])[c:7]([H:20])[c:8]([N:9]2[C:10]([H:21])([H:22])[C:11]([H:23])([H:24])[C:12]([H:25])([H:26])[C:13]2([H:27])[H:28])[n:14][c:15]1[H:29])([H:16])([H:17])[H:18]',
 'AD4': '[C:1]([C:2]1([C:3]([H:25])([H:26])[H:27])[O:4][B:5]([c:6]2[c:7]([H:28])[c:8]([H:29])[c:9]([N:10]3[C:11]([H:30])([H:31])[C:12]([H:32])([H:33])[O:13][C:14]([H:34])([H:35])[C:15]3([H:36])[H:37])[n:16][c:17]2[H:38])[O:18][C:19]1([C:20]([H:39])([H:40])[H:41])[C:21]([H:42])([H:43])[H:44])([H:22])([H:23])[H:24]',
 'AD5': '[C:1]([C:2]([C:3]([H:26])([H:27])[H:28])([C:4]([H:29])([H:30])[H:31])[O:5][C:6](=[O:7])[N:8]1[C:9]([H:32])([H:33])[C:10]([H:34])([H:35])[N:11]([c:12]2[c:13]([H:36])[c:14]([H:37])[c:15]([N+:16](=[O:17])[O-:18])[n:19][c:20]2[H:38])[C:21]([H:39])([H:40])[C:22]1([H:41])[H:42])([H:23])([H:24])[H:25]',
 'AD6': '[C:1]([C:2]([C:3]([H:23])([H:24])[H:25])([C:4]([H:26])([H:27])[H:28])[O:5][C:6](=[O:7])[N:8]1[C:9]([H:29])([H:30])[C:10]([H:31])([H:32])[N:11]([c:12]2[n:13][c:14]([H:33])[c:15]([H:34])[c:16]([H:35])[n:17]2)[C:18]([H:36])([H:37])[C:19]1([H:38])[H:39])([H:20])([H:21])[H:22]',
 'AD7': '[C:1]([N:2]1[C:3]([H:20])([H:21])[C:4]([H:22])([H:23])[N:5]([c:6]2[c:7]([H:24])[c:8]([H:25])[c:9]([N+:10](=[O:11])[O-:12])[c:13]([H:26])[n:14]2)[C:15]([H:27])([H:28])[C:16]1([H:29])[H:30])([H:17])([H:18])[H:19]',
 'AD8': '[O:1]=[N+:2]([O-:3])[c:4]1[c:5]([H:16])[c:6]([H:17])[c:7]([H:18])[n:8][c:9]1[N:10]1[C:11]([H:19])([H:20])[C:12]([H:21])([H:22])[O:13][C:14]([H:23])([H:24])[C:15]1([H:25])[H:26]',
 'AD9': '[O:1]=[N+:2]([O-:3])[c:4]1[c:5]([H:16])[c:6]([H:17])[c:7]([N:8]2[C:9]([H:18])([H:19])[C:10]([H:20])([H:21])[O:11][C:12]([H:22])([H:23])[C:13]2([H:24])[H:25])[n:14][c:15]1[H:26]',
 'AE0': '[C:1]([C:2]([c:3]1[n:4][c:5]([H:16])[c:6]([C:7]([H:17])([H:18])[H:19])[n:8][c:9]1[C:10]([H:20])([H:21])[H:22])([H:14])[H:15])([H:11])([H:12])[H:13]',
 'AE1': '[C:1]([C:2]([O:3][C:4](=[O:5])[C:6]1([H:23])[C:7]([H:24])([H:25])[C:8]([H:26])([H:27])[N:9]([c:10]2[n:11][c:12]([H:28])[c:13]([H:29])[c:14]([H:30])[n:15]2)[C:16]([H:31])([H:32])[C:17]1([H:33])[H:34])([H:21])[H:22])([H:18])([H:19])[H:20]',
 'AE2': '[O:1]=[C:2]1[O:3][C:4]([H:17])([H:18])[C:5]([H:19])([H:20])[N:6]1[N:7]=[C:8]([c:9]1[c:10]([H:22])[c:11]([H:23])[c:12]([N+:13](=[O:14])[O-:15])[o:16]1)[H:21]',
 'AE3': '[C:1]1([H:22])([H:23])[C:2]2([H:24])[O:3][C:4](=[O:5])[O:6][C:7]2([H:25])[C:8]2([H:26])[O:9][S:10](=[O:11])(=[O:12])[O:13][C:14]2([H:27])[C:15]1([O:16][S:17](=[O:18])(=[O:19])[O:20][C:21]([H:29])([H:30])[H:31])[H:28]',
 'AE4': '[C:1]([C:2]1([H:18])[O:3][C:4](=[O:5])[O:6][C:7]([H:19])([H:20])[C:8]1([O:9][S:10](=[O:11])(=[O:12])[O:13][C:14]([H:22])([H:23])[H:24])[H:21])([H:15])([H:16])[H:17]',
 'AE5': '[C:1](/[C:2](=[C:3](/[C:4]1([H:22])[O:5][C:6](=[O:7])[O:8][C:9]([H:23])([H:24])[C:10]1([O:11][S:12](=[O:13])(=[O:14])[O:15][C:16]([H:26])([H:27])[H:28])[H:25])[H:21])[H:20])([H:17])([H:18])[H:19]',
 'AE6': '[O:1]1[C:2](=[O:3])[O:4][C:5]2([H:21])[C:6]1([H:22])[C:7]1([H:23])[O:8][S:9](=[O:10])(=[O:11])[O:12][C:13]1([H:24])[C:14]2([O:15][S:16](=[O:17])(=[O:18])[O:19][C:20]([H:26])([H:27])[H:28])[H:25]'
 }

 
SMILES_DICT.update(tenary_mapped_smiles)

DENSITY_DICT = {
    "DEC": 0.97, "DMC": 1.06, "EA": 0.9, "EC": 1.32, "FEC": 1.45,
    "PC": 1.2, "EMC": 1.01, "VC": 1.355, "ACT": 0.79, "MA": 0.93,
    # "PP": 0.881, "PS": 1.5, "DFEA": 1.18, "EP": 0.884, "FEMC": 1.308,
    # "GBL": 1.12, "SL": 1.261, "DME": 0.867,
    # "HFE": 1.52, "TTE": 1.54, "ADA": 1.32, "ADB": 1.07,
    # "ADC": 1.01, 
    "EMS": 1.09, "EPE": 0.98, "PO7": 1.00,
    'FMPS':1.0,'FMES':1.0,'EMS':1.0,'MIS':1.0,'FMIS':1.0,'FPMS':1.0,'DFEC':1.0,
    'PTHF':1.00,'PEO':1.00,'PDOL':1.00,'PTOM':1.00,
    # 'T1':1.00,'T2':1.00,'T3':1.00,'T4':1.00,'T5':1.00,'T6':1.00,'T7':1.00,'T8':1.00,'T9':1.00,'T10':1.00,'T11':1.00,'T12':1.00,'T13':1.00,
}

for key in tenary_mapped_smiles:
    DENSITY_DICT[key] = 1.00

# ========== 构建数据库 ==========
def smiles_to_molar_mass(smiles: str) -> float:
    mol = Chem.MolFromSmiles(smiles)
    if mol is None:
        raise ValueError(f"Invalid SMILES: {smiles}")
    return Descriptors.ExactMolWt(mol)

MOLECULE_DB, missing_density = {}, []
for name, smiles in SMILES_DICT.items():
    try:
        molar_mass = smiles_to_molar_mass(smiles)
    except Exception as e:
        print(f"⚠️ Error for {name}: {e}")
        continue
    density = DENSITY_DICT.get(name)
    if density is None:
        missing_density.append(name)
    MOLECULE_DB[name] = (round(molar_mass, 2), density)

mol_charges = {}
for name, smiles in SMILES_DICT.items():
    mol = Chem.MolFromSmiles(smiles)
    total_charge = 0 if mol is None else sum(atom.GetFormalCharge() for atom in mol.GetAtoms())
    mol_charges[name] = total_charge

# ========== 解析公式 ==========
def parse_formula(text):
    text = text.strip()
    result = {
        'solute': None,
        'concentration': None,
        'unit': None,          # 'M' or 'm'
        'solvents': {},
        'ratio_type': None,    # 'vol' or 'wt'
        'additives': [],        # list of dicts
        'temperature': None
    }
    # ============= Step 0: Extract temperature if present at beginning
    temp_match = re.match(r'^(\d+(?:\.\d+)?)\s+(.*)', text)
    if temp_match:
        result['temperature'] = float(temp_match.group(1))
        text = temp_match.group(2).strip()

    # ============= Step 1: Handle additives (e.g., + 2wt% VC)
    additives = []
    add_pattern = r'\+\s*(\d+(?:\.\d+)?)\s*wt%\s*([A-Za-z0-9]+)'
    for match in re.finditer(add_pattern, text, re.IGNORECASE):
        amount = float(match.group(1))
        name = match.group(2).strip()
        additives.append({'name': name, 'amount': amount, 'unit': 'wt%'})
    # Remove additives from main string for easier parsing
    main_text = re.sub(add_pattern, '', text, flags=re.IGNORECASE).strip()
    if main_text.endswith('+'):
        main_text = main_text[:-1].strip()

    # ============= Step 2: Extract solute and concentration
    # Pattern 1: "1M LiPF6" or "0.9m LiFSI"
    pattern1 = r'^(\d+(?:\.\d+)?)\s*([Mm])\s+([A-Za-z0-9]+)'
    # Pattern 2: "LiPF6:1M" or "LiFSI:0.9m"
    pattern2 = r'^([A-Za-z0-9]+)\s*:\s*(\d+(?:\.\d+)?)\s*([Mm])'

    solute = None
    concentration = None
    unit = None

    match1 = re.match(pattern1, main_text)
    match2 = re.match(pattern2, main_text)

    if match1:
        concentration = float(match1.group(1))
        unit = match1.group(2)
        solute = match1.group(3)
        rest = main_text[match1.end():].strip()
    elif match2:
        solute = match2.group(1)
        concentration = float(match2.group(2))
        unit = match2.group(3)
        rest = main_text[match2.end():].strip()
    else:
        raise ValueError(f"Cannot parse solute/concentration from: {text}")

    # ============= Step 3: Parse solvent part
    # Remove leading "in"
    if rest.lower().startswith('in '):
        rest = rest[3:].strip()

    # Determine ratio type: vol or wt
    ratio_type = None
    if '(vol.)' in rest or 'by volume' in rest:
        ratio_type = 'vol'
    elif '(wt%)' in rest or 'by weight' in rest:
        ratio_type = 'wt'
    else:
        # Default to vol if not specified (common in literature)
        ratio_type = 'vol'

    # Clean solvent string
    solvent_str = rest
    for suffix in ['(vol.)', '(wt%)', 'by volume', 'by weight']:
        solvent_str = solvent_str.replace(suffix, '')
    solvent_str = re.sub(r'\s+', ' ', solvent_str).strip()

    # Now parse solvents
    solvents = {}
    if ',' in solvent_str:
        # Format: "FEC:2, FEMC:6, HFE:2"
        parts = [p.strip() for p in solvent_str.split(',')]
        for part in parts:
            if ':' in part:
                name, ratio = part.split(':', 1)
                solvents[name.strip()] = float(ratio.strip())
    else:
        # Format: "DEC:EC 1:1" or "PC" (single solvent)
        if ':' in solvent_str and any(c.isdigit() for c in solvent_str):
            # Split into names and ratios
            try:
                names_part, ratios_part = solvent_str.split(maxsplit=1)
                names = names_part.split(':')
                ratios = ratios_part.split(':')
                if len(names) == len(ratios):
                    for n, r in zip(names, ratios):
                        solvents[n.strip()] = float(r.strip())
                else:
                    # Fallback: maybe single solvent like "PC"
                    if len(names) == 1 and not ratios_part.strip().replace(':', '').replace(' ', '').isdigit():
                        solvents[names[0].strip()] = 1.0
                    else:
                        raise ValueError("Mismatch in solvent names and ratios")
            except Exception:
                # Try treating as single solvent
                solvents[solvent_str.strip()] = 1.0
        else:
            # Single solvent like "PC"
            solvent_name = solvent_str.strip()
            if solvent_name:
                solvents[solvent_name] = 1.0

    # ============= Assemble result
    result['solute'] = solute
    result['concentration'] = concentration
    result['unit'] = unit
    result['solvents'] = solvents
    result['ratio_type'] = ratio_type
    result['additives'] = additives

    return result

# ========== 分子数计算 ==========
NA = 6.02214076e23
BOX_NM = 5.0
VOL_CM3 = (BOX_NM ** 3) * 1e-21  # nm³ → cm³
VOL_L = VOL_CM3 * 1e-3           # cm³ → L

def calculate_counts(parsed_formulas, db,  box_nm=5.0):
    BOX_NM = box_nm
    VOL_CM3 = (BOX_NM ** 3) * 1e-21  # nm³ → cm³
    VOL_L = VOL_CM3 * 1e-3           # cm³ → L
    results = []
    solute_to_ions = {
        'LiPF6': ('LI','PF6'), 'LiFSI': ('LI','FSI'), 'LiTFSI': ('LI','TFSI'),
        'NaPF6': ('NA','PF6'), 'NaFSI': ('NA','FSI'), 'NaTFSI': ('NA','TFSI')
    }

    for i, pf in enumerate(parsed_formulas):
        solute, conc, unit = pf['solute'], pf['concentration'], pf['unit']
        solvents, ratio_type, additives = pf['solvents'], pf['ratio_type'], pf['additives']
        counts = {}

        # Step 1: 溶剂
        if ratio_type == 'wt':
            total_ratio = sum(solvents.values())
            weight_fractions = {n: w/total_ratio for n, w in solvents.items()}
            inv_rho_mix = sum(wf/db[n][1] for n, wf in weight_fractions.items())
            rho_mix = 1.0 / inv_rho_mix
            total_mass_g = rho_mix * VOL_CM3
            for n, w in solvents.items():
                wf = w/total_ratio
                mass_g = total_mass_g * wf
                counts[n] = int(round((mass_g/db[n][0]) * NA))
        # elif ratio_type == 'vol':
        #     total_ratio = sum(solvents.values())
        #     for n, v in solvents.items():
        #         vol_frac = v/total_ratio
        #         vol_cm3 = vol_frac * VOL_CM3
        #         print(db[n][1])
        #         mass_g = db[n][1] * vol_cm3
        #         counts[n] = int(round((mass_g/db[n][0]) * NA))

        elif ratio_type == 'vol':
            total_ratio = sum(solvents.values())
            for n, v in solvents.items():
                vol_frac = v / total_ratio

                # Step 1: 在 1 L 下的摩尔数
                vol_cm3_1L = vol_frac * 1000.0   # cm³
                mol_1L = (db[n][1] * vol_cm3_1L) / db[n][0]

                # Step 2: 转换到实际盒子体积
                mol_box = mol_1L * VOL_L
                counts[n] = int(round(mol_box * NA))

        # Step 2: 添加剂 (wt%)
        if additives:
            total_solvent_mass = sum((counts[n] * db[n][0]) / NA for n in solvents)  # g

            for add in additives:
                add_name = add['name']
                add_wt_pct = add['amount']
                if add_name in solute_to_ions:
                    # 拆分为离子
                    cation, anion = solute_to_ions[add_name]
                    if cation not in db or anion not in db:
                        raise KeyError(f"Missing mass info for ion components of {add_name}")
                    mol_mass = db[cation][0] + db[anion][0]  # g/mol
                    add_mass_g = (add_wt_pct / 100.0) * total_solvent_mass
                    mol_count = int(round((add_mass_g / mol_mass) * NA))
                    counts[cation] = counts.get(cation, 0) + mol_count
                    counts[anion] = counts.get(anion, 0) + mol_count
                else:
                    # 中性分子
                    if add_name not in db:
                        raise KeyError(f"Additive {add_name} not in database")
                    mol_mass = db[add_name][0]
                    add_mass_g = (add_wt_pct / 100.0) * total_solvent_mass
                    mol_count = int(round((add_mass_g / mol_mass) * NA))
                    counts[add_name] = counts.get(add_name, 0) + mol_count

        # Step 3: 溶质
        if unit == 'M':
            mol_solute = conc * VOL_L
        elif unit == 'm':
            total_solvent_mass_kg = sum((counts[n]*db[n][0])/NA for n in solvents)/1000.0
            mol_solute = conc * total_solvent_mass_kg
        else:
            raise ValueError(f"Unknown unit: {unit}")
        count_solute = int(round(mol_solute * NA))

        if solute in solute_to_ions:
            cation, anion = solute_to_ions[solute]
            counts[cation] = count_solute
            counts[anion] = count_solute
        else:
            counts[solute] = count_solute

        results.append(counts)
    return results

def mass_fraction_to_counts(mass_fraction_dict, db, solute_to_ions=None, box_nm=5.0):
    NA = 6.02214076e23
    vol_cm3 = (box_nm ** 3) * 1e-21  # nm³ → cm³

    if solute_to_ions is None:
        solute_to_ions = {
            'LiPF6': ('LI', 'PF6'),
            'LiFSI': ('LI', 'FSI'),
            'LiTFSI': ('LI', 'TFSI'),
            'LiDFOB': ('LI', 'DFOB'),
            'NaPF6': ('NA', 'PF6'),
            'NaFSI': ('NA', 'FSI'),
            'NaTFSI': ('NA', 'TFSI'),
        }

    # 分离溶剂和盐类
    solvent_names = [name for name in mass_fraction_dict if name not in solute_to_ions]
    salt_names = [name for name in mass_fraction_dict if name in solute_to_ions]

    # 检查溶剂密度是否缺失
    missing = [name for name in solvent_names if name not in db or db[name][1] is None]
    if missing:
        raise ValueError(f"Missing density info for solvents: {missing}")

    # Normalize fractions
    total = sum(mass_fraction_dict.values())
    weight_fractions = {name: w / total for name, w in mass_fraction_dict.items()}

    # Compute mixture density using only solvents
    inv_rho_mix = sum(weight_fractions[name] / db[name][1] for name in solvent_names)
    rho_mix = 1.0 / inv_rho_mix  # g/cm³

    # Total mass in box
    total_mass_g = rho_mix * vol_cm3

    # Compute counts
    counts = {}

    # Step 1: 溶剂
    for name in solvent_names:
        wf = weight_fractions[name]
        mass_g = total_mass_g * wf
        mol_mass = db[name][0]
        mol_count = int(round((mass_g / mol_mass) * NA))
        counts[name] = mol_count

    # Step 2: 盐类（拆分为离子）
    total_solvent_mass = sum((counts[n] * db[n][0]) / NA for n in solvent_names)
    for name in salt_names:
        wf = weight_fractions[name]
        salt_mass_g = total_solvent_mass * wf / sum(weight_fractions[n] for n in solvent_names)  # scale to solvent mass
        cation, anion = solute_to_ions[name]
        if cation not in db or anion not in db:
            raise KeyError(f"Missing molar mass for ion components of {name}")
        mol_mass = db[cation][0] + db[anion][0]
        mol_count = int(round((salt_mass_g / mol_mass) * NA))
        counts[cation] = counts.get(cation, 0) + mol_count
        counts[anion] = counts.get(anion, 0) + mol_count

    return counts

def mol_to_counts(mol_dict, db, solute_to_ions=None, box_nm=5.0):
    """
    Convert molar composition to particle counts in a simulation box.
    mol_dict: dict of {component: mol}
    db: dict of {component: (molar_mass, density)} in g/mol and g/cm³
    solute_to_ions: dict of {salt: (cation, anion)}
    box_nm: box size in nanometers
    """
    NA = 6.02214076e23
    vol_cm3 = (box_nm ** 3) * 1e-21  # nm³ → cm³

    if solute_to_ions is None:
        solute_to_ions = {
            'LiPF6': ('LI', 'PF6'),
            'LiFSI': ('LI', 'FSI'),
            'LiTFSI': ('LI', 'TFSI'),
            'NaPF6': ('NA', 'PF6'),
            'NaFSI': ('NA', 'FSI'),
            'NaTFSI': ('NA', 'TFSI'),
        }

    # 分离溶剂和盐类
    solvent_names = [name for name in mol_dict if name not in solute_to_ions]
    salt_names = [name for name in mol_dict if name in solute_to_ions]

    # 检查密度信息
    missing = [name for name in solvent_names if name not in db or db[name][1] is None]
    if missing:
        raise ValueError(f"Missing density info for solvents: {missing}")

    # 计算溶剂总质量
    total_solvent_mass = sum(mol_dict[name] * db[name][0] for name in solvent_names)  # g
    total_solvent_volume = sum(mol_dict[name] * db[name][0] / db[name][1] for name in solvent_names)  # cm³
    rho_mix = total_solvent_mass / total_solvent_volume  # g/cm³

    # 缩放因子：将总质量缩放到 box 体积
    scale = (rho_mix * vol_cm3) / total_solvent_mass

    counts = {}

    # Step 1: 溶剂
    for name in solvent_names:
        mol = mol_dict[name] * scale
        counts[name] = int(round(mol * NA))

    # Step 2: 盐类 → 拆分为离子
    for name in salt_names:
        mol = mol_dict[name] * scale
        cation, anion = solute_to_ions[name]
        counts[cation] = counts.get(cation, 0) + int(round(mol * NA))
        counts[anion] = counts.get(anion, 0) + int(round(mol * NA))

    return counts


# ========== PDB 质量提取 ==========
def get_mol_masses():
    def parse_pdb_for_masses(pdb_file):
        masses = []
        with open(pdb_file,'r') as f:
            for line in f:
                if line.startswith(('ATOM','HETATM')):
                    element = line[76:78].strip().upper()
                    if not element:
                        atom_name = line[12:16].strip()
                        elem = ''.join([c for c in atom_name if c.isalpha()])
                        element = elem[:2].upper() if len(elem)>=2 else elem.upper()
                    if element in element_to_mass:
                        masses.append(element_to_mass[element])
        return masses
    mol_masses = {}
    for pdb_file in glob.glob('template/input_data/*/*.pdb'):
        mol_name = os.path.splitext(os.path.basename(pdb_file))[0]
        masses = parse_pdb_for_masses(pdb_file)
        if masses: mol_masses[mol_name] = masses
    return mol_masses

# ========== 文件生成 ==========
def save_run_file(folder, mol_masses, mol_counts, temperature=298, template_py="template/run_transport.py"):
    # template_py = "template/run_transport.py"
    output_py = os.path.join(folder,"run_md.py")
    with open(template_py,'r') as f: content = f.read()
    content = re.sub(r'TEMPERATURE\s*=\s*\d+', f'TEMPERATURE = {temperature}', content)

    number_dict_str = ", ".join([f'"{k}": {v}' for k,v in mol_counts.items()])
    content = re.sub(r'species_number_dict = \{.*?\}', f'species_number_dict = {{{number_dict_str}}}', content, flags=re.DOTALL)
    charge_dict_str = ", ".join([f'"{k}": {mol_charges[k]}' for k in mol_counts])
    content = re.sub(r'species_charges_dict = \{.*?\}', f'species_charges_dict = {{{charge_dict_str}}}', content, flags=re.DOTALL)
    mass_dict_lines = [f'    "{mol}": [{", ".join(str(m) for m in mol_masses.get(mol,[12.0]))}]' for mol in mol_counts]
    mass_dict_full = "species_mass_dict = {\n" + ",\n".join(mass_dict_lines) + "\n}"
    content = re.sub(r'species_mass_dict = \{.*?\}', mass_dict_full, content, flags=re.DOTALL)
    mol_list_str = ", ".join([f"'{k}'" for k in mol_counts])
    content = re.sub(r"for mol in \[.*?\]:", f"for mol in [{mol_list_str}]:", content)
    with open(output_py,'w') as f: f.write(content)

def save_pack_file(folder, mol_counts):
    template_pack = "template/input_data/pack_data.py"
    output_pack = os.path.join(folder,"prepare_system.py")
    with open(template_pack,'r') as f: pack_content = f.read()
    mol_entries = [f"    '/AI4S/Projects/CAFF/md_five/template/input_data/{mol}/{mol}.gro': {{'resname': '{mol}', 'count': {count}}}," for mol,count in mol_counts.items()]
    mol_dict_str = "{\n" + "\n".join(mol_entries) + "\n}"
    pack_content = re.sub(r"molecules = \{.*?\}", f"molecules = {mol_dict_str}", pack_content, flags=re.DOTALL)
    total_mols = sum(mol_counts.values())
    # box_size = (total_mols*120)**(1/3)
    # box_size = max(50.0,min(100.0,box_size))
    box_size = 150.0
    pack_content = re.sub(r"box_size = .*?#", f"box_size = {box_size:.1f}  #", pack_content)
    with open(output_pack,'w') as f: f.write(pack_content)

def save_topo_file(folder, mol_counts):
    topol_content = "[ defaults ]\n1 3 yes 0.5 0.5\n\n[ atomtypes ]\n"
    for mol in mol_counts:
        topol_content += f'#include "/AI4S/Projects/CAFF/md_five/template/input_data/{mol}/{mol}.atp"\n'
    for mol in mol_counts:
        topol_content += f'#include "/AI4S/Projects/CAFF/md_five/template/input_data/{mol}/{mol}.itp"\n'
    topol_content += "\n[ system ]\n" + " ".join(mol_counts.keys()) + "\n\n[molecules]\n"
    for mol,count in mol_counts.items():
        topol_content += f"{mol} {count}\n"
    with open(os.path.join(folder,"topol.top"),'w') as f: f.write(topol_content)

def read_mol_table(path, sep='\t'):
    df = pd.read_csv(path, sep=sep)
    mol_cols = [c for c in df.columns if 'mol' in c and c != "label"]
    component_names = [c.split(' (mol)')[0] for c in mol_cols]
    results = []
    for _, row in df.iterrows():
        mol_dict = {
            name: float(row[col])
            for name, col in zip(component_names, mol_cols)
            if pd.notna(row[col]) and row[col] != 0
        }
        results.append(mol_dict)
    return results

# ========== 主程序 ==========
if __name__ == "__main__":

    mass_ratio_dicts = [{'EC': 16.186,
    'EMC': 64.744,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 16.08,
    'EMC': 64.32,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'T3': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 16.08,
    'EMC': 64.32,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'T12': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 16.08,
    'EMC': 64.32,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'T2': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 16.08,
    'EMC': 64.32,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'T8': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 16.08,
    'EMC': 64.32,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'T9': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 15.98,
    'EMC': 63.92,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'T1': 1.0,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 15.98,
    'EMC': 63.92,
    'T3': 0.7,
    'T7': 3.0,
    'T13': 2.0,
    'T1': 1.0,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 16.086,
    'EMC': 64.344,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'T4': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    {'EC': 16.086,
    'EMC': 64.344,
    'T3': 0.7,
    'T13': 2.0,
    'T5': 3.0,
    'T4': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.62},
    #################
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'T4': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA0': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA1': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA2': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA3': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA4': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA5': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA6': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA7': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA8': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AA9': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB0': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB1': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB2': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB3': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB4': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB5': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB6': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB7': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB8': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AB9': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC0': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC1': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC2': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC3': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC4': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC5': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC6': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC7': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC8': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AC9': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD0': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD1': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD2': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD3': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD4': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD5': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD6': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD7': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD8': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AD9': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AE0': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AE1': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AE2': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AE3': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AE4': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AE5': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56},
    {'EC': 16.138,
    'EMC': 64.552,
    'T11': 3.0,
    'T10': 0.7,
    'T6': 2.0,
    'AE6': 0.5,
    'LiPF6': 8.75,
    'LiFSI': 4.56}
    ]

    results = []
    for ratio in mass_ratio_dicts:
        counts = mass_fraction_to_counts(ratio, MOLECULE_DB)
        results.append(counts)
    print(results)


    for ipt, mol_counts in enumerate(results):
        # folder = f"11nmr/test_md_{ipt}"
        folder = f"3y/newer_md_{ipt}"

        if os.path.exists(folder):
            continue
        else:
            os.makedirs(folder, exist_ok=True)
            mol_masses = get_mol_masses()
            save_run_file(folder, mol_masses, mol_counts)
            save_pack_file(folder, mol_counts)
            save_topo_file(folder, mol_counts)
            shutil.copy('template/run.sh', folder)
            
    # STANDARDIZED FORMULA NAME
    formulas = []
    with open("formula_opendata.txt","r") as f:
        for line in f:
            line=line.strip()
            if line and not line.startswith("#"):
                formulas.append(line.split('\t')[1])
    parsed = [parse_formula(f) for f in formulas]
    results = calculate_counts(parsed, MOLECULE_DB)

    # # # MASS FRACTION TO COUNTS
    # df = pd.read_csv("formula_cond_3y.csv")
    # df = pd.read_csv("formula_polymer.csv")
    # cols = [c for c in df.columns if c != "label" and '(' not in c]
    # mass_ratio_dicts = {
    #     row["label"]: {
    #         col: float(val)
    #         for col, val in row[cols].items()
    #         if pd.notna(val) and val != 0
    #     }
    #     for _, row in df.iterrows()
    # }
    # for name, ratio in mass_ratio_dicts.items():
    #     print(f"{name}: {ratio}")

    # # mass_ratio_dicts = {'ecl2': {'PO7': 88.0, 'LiTFSI': 38.0},}

    # results = []
    # for name, ratio in mass_ratio_dicts.items():
    #     counts = mass_fraction_to_counts(ratio, MOLECULE_DB)
    #     results.append(counts)
    # print(results)

    # results = []
    # for i in [33, 84, 134, 251, 335, 502]:
    #     results.append({'PEO': 31, 'LI': i, 'TFSI': i})

    # results = []
    # for i in [33, 84, 134, 251, 335, 502]:
    #     results.append({'PEO': 31, 'LI': i, 'TFSI': i})

    
    # for ipt, mol_counts in enumerate(results):
    #     # folder = f"11nmr/test_md_{ipt}"
    #     folder = f"9_polymer/md_LiEO_{ipt}"

    #     if os.path.exists(folder):
    #         continue
    #     else:
    #         os.makedirs(folder, exist_ok=True)
    #         mol_masses = get_mol_masses()
    #         save_run_file(folder, mol_masses, mol_counts)
    #         save_pack_file(folder, mol_counts)
    #         save_topo_file(folder, mol_counts)
    #         shutil.copy('template/run.sh', folder)

    # df = pd.read_csv("formula_11nmr.csv")
    # cols = [c for c in df.columns if c != "label" and '(' not in c]
    # mass_ratio_dicts = {
    #     row["label"]: {
    #         col: float(val)
    #         for col, val in row[cols].items()
    #         if pd.notna(val) and val != 0
    #     }
    #     for _, row in df.iterrows()
    # }
    # for name, ratio in mass_ratio_dicts.items():
    #     print(f"{name}: {ratio}")
    # results = []
    # for name, ratio in mass_ratio_dicts.items():
    #     counts = mass_fraction_to_counts(ratio, MOLECULE_DB)
    #     results.append(counts)

    # MW = {
    #     "LiPF6": 151.9,
    #     "EC": 88.06,
    #     "DMC": 90.08,
    #     "VC": 86.05
    # }
    # solute_to_ions = {
    #     'LiPF6': ('LI', 'PF6'),
    #     'LiFSI': ('LI', 'FSI'),
    #     'LiTFSI': ('LI', 'TFSI'),
    #     'NaPF6': ('NA', 'PF6'),
    #     'NaFSI': ('NA', 'FSI'),
    #     'NaTFSI': ('NA', 'TFSI'),
    # }
    # results = []
    # columns = df.columns[1:]
    # for idx, row in df.iterrows():
    #     masses = {col: row[col] for col in columns}
    #     moles = {col: masses[col] / MW[col] for col in columns}
    #     total_moles = sum(moles.values())
    #     molecules = {col: round(moles[col] / total_moles * 300) for col in columns}
    #     for molecule in molecules:
    #         if molecule in solute_to_ions:
    #             molecules[solute_to_ions[molecule][0]] = molecules[molecule]
    #             molecules[solute_to_ions[molecule][1]] = molecules[molecule]
    #             del molecules[molecule]
    #             break
    #     for molecule in molecules:
    #         if molecules[molecule] == 0:
    #             del molecules[molecule] 
    #             break
    #     results.append(molecules)

    # # 输出结果表格
    # result_df = pd.DataFrame(results)
    # print(result_df)
    # # production
    # for ipt, mol_counts in enumerate(results):
    #     folder = f"11nmr/test_md_{ipt}"
    #     if os.path.exists(folder):
    #         continue
    #     else:
    #         os.makedirs(folder, exist_ok=True)
    #         mol_masses = get_mol_masses()
    #         save_run_file(folder, mol_masses, mol_counts)
    #         save_pack_file(folder, mol_counts)
    #         save_topo_file(folder, mol_counts)
    #         shutil.copy('template/run.sh', folder)



    # # MOL FRACTION TO COUNTS
    # mol_ratio_dicts = read_mol_table("formula_xm_mol.csv",sep='\t')
    # results = []
    # for ratio in mol_ratio_dicts:
    #     counts = mol_to_counts(ratio, MOLECULE_DB, box_nm=5.0)
    #     results.append(counts)    

    # # production
    # for ipt, mol_counts in enumerate(results):
    #     folder = f"11nmr/test_md_{ipt}"
    #     if os.path.exists(folder):
    #         continue
    #     else:
    #         os.makedirs(folder, exist_ok=True)
    #         mol_masses = get_mol_masses()
    #         save_run_file(folder, mol_masses, mol_counts)
    #         save_pack_file(folder, mol_counts)
    #         save_topo_file(folder, mol_counts)
    #         shutil.copy('template/run.sh', folder)



    # STANDARDIZED FORMULA NAME WITH TEMPERATURE
    # formulas = []
    # # with open("formula_opendata2.txt","r") as f:
    # with open("formula_ox.txt","r") as f:
    #     for line in f:
    #         line=line.strip()
    #         if line and not line.startswith("#"):
    #             formulas.append(line.split('\t'))
    # lines = []
    # for row in formulas:
    #     temp_field = row[0].strip()
    #     formula_text = row[1].strip()
    #     parts = temp_field.split()
    #     if len(parts) == 2:
    #         _, temp = parts
    #     else:
    #         temp = parts[0]
    #     lines.append(f"{temp} {formula_text}")
    # parsed = [parse_formula(line) for line in lines]

    # results = calculate_counts(parsed, MOLECULE_DB, box_nm=4.0)
    # for ipt, mol_counts in enumerate(results):
    #     if "NA" not in mol_counts:
    #         temp = parsed[ipt]['temperature']
    #         folder = f"10density/test_md_{ipt}"
    #         os.makedirs(folder, exist_ok=True)
    #         mol_masses = get_mol_masses()
    #         save_run_file(folder, mol_masses, mol_counts,temperature=temp)
    #         save_pack_file(folder, mol_counts)
    #         save_topo_file(folder, mol_counts)

    # import json
    # with open('processed_data_Dr.tie.json','r') as ifile:
    #     data = json.load(ifile)

    # mol_ratio_dicts = []
    # for formula in data:
    #     if formula['temperature'] == 0.7990084416454509:
    #         mol_ratio_dict = {}
    #         for salt in formula['salts']:
    #             mol_ratio_dict[salt['name']] = salt['molar_ratio'] * formula['salt_molar_ratio']
    #         for solvent in formula['solvents']:
    #             mol_ratio_dict[solvent['name']] = solvent['molar_ratio'] * (1 - formula['salt_molar_ratio'])
    #         mol_ratio_dicts.append(mol_ratio_dict)

    # results = []
    # for ratio in mol_ratio_dicts:
    #     counts = mol_to_counts(ratio, MOLECULE_DB, box_nm=5.0)
    #     results.append(counts)    
    
    # temp = 298
    # # production
    # for ipt, mol_counts in enumerate(results):
    #     if "NA" not in mol_counts:
    #         folder = f"10density/test_md_{ipt}"
    #         os.makedirs(folder, exist_ok=True)
    #         mol_masses = get_mol_masses()
    #         save_run_file(folder, mol_masses, mol_counts,temperature=temp,template_py="template/run_transport.py")
    #         save_pack_file(folder, mol_counts)
    #         save_topo_file(folder, mol_counts)
